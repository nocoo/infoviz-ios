define(function(b,a,c){a.draw_bubblechart=function(e,r,X,F,P,L){if(!e||!X){return idb("Paper or Data is empty.")}var E=b("./infoviz.core");var B=E.merge_options(F),s=[],W,R,O,n,H;var C=Infinity,aa=-Infinity,J=Infinity,m=-Infinity,f=-Infinity,G=Infinity;for(W=0;W<X.data.length;++W){H=X.data[W];if(H[X.horizontal_field]>aa){aa=H[X.horizontal_field]}if(H[X.horizontal_field]<C){C=H[X.horizontal_field]}if(H[X.vertical_field]>m){m=H[X.vertical_field]}if(H[X.vertical_field]<J){J=H[X.vertical_field]}if(H[X.size_field]>f){f=H[X.size_field]}if(H[X.size_field]<G){G=H[X.size_field]}}C=Math.floor(C/10)*10;aa=Math.ceil(aa/10)*10;J=Math.floor(J/10)*10;m=Math.ceil(m/10)*10;var T=r["top-left"][0]+B.bubblechart["padding-left"];var A=(r["top-right"][0]-B.bubblechart["padding-right"]-T)/(aa-C);var V=r["bottom-left"][1]-B.bubblechart["padding-bottom"];var K=(V-r["top-left"][1]-B.bubblechart["padding-top"])/(m-J);var Z=B.bubblechart["circle-min-radius"];var w=(B.bubblechart["circle-max-radius"]-Z)/(f-G);var j,Y,v,Q,z,u,M;var S=[],D=[],g=[];for(W=0;W<X.data.length;++W){H=X.data[W];j=H[X.horizontal_field];Y=H[X.vertical_field];v=H[X.size_field];Q=H[X.label_field];z=B.color[(W%B.color.length)];n=Z+v*w;R=T+(j-C)*A;O=V-(Y-J)*K;u=e.circle(R,O,n).attr({fill:z.color,"fill-opacity":z["light-alpha"],stroke:z.color,"stroke-opacity":z["dark-alpha"],"stroke-width":B.bubblechart["circle-border-width"]}).translate(0.5,0.5);M=e.text(R,O,Q).attr({fill:B.bubblechart["label-color"],"font-size":B.bubblechart["label-size"],"text-anchor":"middle"}).translate(0.5,0.5);u.data("data",H);M.data("data",H);D.push(u);g.push(M);S.push({label:Q,color:z,type:"circle"});if(P&&typeof(P)==="function"){u.data("info",{x:R,y:O,v_value:Y,h_value:j,data:H,type:"circle",callback:P,that:L});u.click(E.element_action);M.data("info",{x:R,y:O,v_value:Y,h_value:j,data:H,type:"label",callback:P,that:L});M.click(E.element_action)}if(X.tooltip_title||X.tooltip_content){var I=X.tooltip_title;var q=X.tooltip_content;for(var U in H){I=I.replace("{"+U+"}",H[U]);q=q.replace("{"+U+"}",H[U])}M.data("tooltip",{id:W,title:I,content:q,color:z,x:R,y:O-n,element:M,options:B,paper:e});M.hover(E.element_tooltip)}}E.draw_legend(e,r,S,B);var t=(V-r["top-left"][1]-B.bubblechart["padding-top"])/(B.grid["vertical-label-count"]-1);var l=(m-J)/(B.grid["vertical-label-count"]-1);s=[];R=r["top-left"][0]-B.grid["vertical-bar-width"];O=V;var k=J;for(W=0;W<B.grid["vertical-label-count"];++W){s.push("M"+R+","+O+"L"+r["top-left"][0]+","+O);e.path(s.join("")).attr({stroke:B.grid["axis-color"],"stroke-opacity":B.grid["axis-alpha"],"stroke-width":B.grid["axis-width"]}).translate(0.5,0.5);e.text(R-B.grid["vertical-bar-width"],O,k.toFixed(B.grid["vertical-label-round"])).attr({"text-anchor":"end",fill:B.grid["vertical-label-color"],"font-size":B.grid["vertical-label-size"]}).translate(0.5,0.5);O-=t;k+=l}var N=(r["top-right"][0]-B.bubblechart["padding-right"]-T)/(B.grid["vertical-label-count"]-1);var d=(aa-C)/(B.grid["vertical-label-count"]-1);s=[];R=T;O=r["bottom-left"][1]+B.bubblechart["horizontal-bar-width"];var h=C,o;for(W=0;W<B.bubblechart["horizontal-label-count"];++W){s.push("M"+R+","+O+"L"+R+","+r["bottom-left"][1]);e.path(s.join("")).attr({stroke:B.grid["axis-color"],"stroke-opacity":B.grid["axis-alpha"],"stroke-width":B.grid["axis-width"]}).translate(0.5,0.5);o=e.text(R,O+B.bubblechart["horizontal-bar-width"]*2,h.toFixed(B.grid["vertical-label-round"])).attr({fill:B.grid["horizontal-label-color"],"font-size":B.grid["horizontal-label-size"]}).translate(0.5,0.5);if(B.grid["horizontal-label-rotate"]){o.transform("r"+B.grid["horizontal-label-rotate"])}R+=N;h+=d}}});