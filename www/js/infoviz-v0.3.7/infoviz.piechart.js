define(function(b,a,c){b.async(["./infoviz.core"],function(d){a.draw_piechart=function(g,m,X,E,L,I){if(!g||!X){return idb("Paper or Data is empty.")}var C=d.merge_options(E),n=[],O,K,V,F,Q;var w=C.piechart["hole-radius"];var A=m["top-left"][0]+m.width/2+C.piechart["horizontal-offset"];var z=m["top-left"][1]+m.height/2+C.piechart["vertical-offset"];if(m.width>m.height){Q=Math.floor(m.height/2)*C.piechart["size-factor"]}else{Q=Math.floor(m.width/2)*C.piechart["size-factor"]}var j=-Infinity,H=Infinity,h=0;for(V=0;V<X.data.length;++V){F=X.data[V];if(F[X.value_field]>j){j=F[X.value_field]}if(F[X.value_field]<H){H=F[X.value_field]}h+=F[X.value_field]}var D=function(ae,ac,p,i,af,ab,ad){var ag=Math.PI/180,y=ae+p*Math.cos(-af*ag),x=ae+p*Math.cos(-ab*ag),ai=ac+p*Math.sin(-af*ag),ah=ac+p*Math.sin(-ab*ag);t=ae+i*Math.cos(-af*ag),r=ae+i*Math.cos(-ab*ag),Z=ac+i*Math.sin(-af*ag),Y=ac+i*Math.sin(-ab*ag);if(i>0){return g.path(["M",t,Z,"L",y,ai,"A",p,p,0,+(ab-af>180),0,x,ah,"L",r,Y,"A",i,i,0,-(ab-af>180),1,t,Z]).attr(ad)}else{return g.path(["M",ae,ac,"L",y,ai,"A",p,p,0,+(ab-af>180),0,x,ah,"z"]).attr(ad)}};var q=360/h;var s,k=0,B,S=[],v=[],o=[],f;var u,aa,t,Z,r,Y,U;var N,T,M;var P=[];for(V=0;V<X.data.length;++V){F=X.data[V][X.value_field];s=q*F;B=C.color[(V%C.color.length)];N=D(A,z,Q,w,k,k+s,{fill:B.color,"fill-opacity":B["light-alpha"],stroke:B.color,"stroke-opacity":B["dark-alpha"],"stroke-width":C.piechart["sector-border-width"]}).translate(0.5,0.5);N.data("color-alpha",B["light-alpha"]);N.data("index",V);S.push(N);if(L&&typeof(L)==="function"){N.data("info",{start:k,angle:s,value:X.data[V][X.value_field],data:X.data[V],callback:L,that:I});N.click(d.element_action)}P.push({label:X.data[V][X.label_field],color:B,type:"sector"});f=-(k+s/2)*Math.PI/180;O=A+(Q+C.piechart["label-distance"])*Math.cos(f);K=z+(Q+C.piechart["label-distance"])*Math.sin(f);u=A+(Q+C.piechart["label-distance"]+C.piechart["label-bar-length1"])*Math.cos(f);aa=z+(Q+C.piechart["label-distance"]+C.piechart["label-bar-length1"])*Math.sin(f);if(O>A){t=u+C.piechart["label-bar-length2"]}else{t=u-C.piechart["label-bar-length2"]}Z=aa;n=[];n.push("M"+O+","+K);n.push("L"+u+","+aa);n.push("L"+t+","+Z);T=g.path(n.join("")).attr({stroke:C.piechart["label-bar-color"],"stroke-opacity":C.piechart["label-bar-color"],"stroke-width":C.piechart["label-bar-width"]}).translate(0.5,0.5);v.push(T);if(O>A){r=t+C.piechart["label-distance"];U="start"}else{r=t-C.piechart["label-distance"];U="end"}Y=Z;M=g.text(r,Y,X.data[V][X.label_field]).attr({"text-anchor":U,fill:B.color,"font-size":C.piechart["label-size"]}).translate(0.5,0.5);o.push(M);if(X.tooltip_title||X.tooltip_content){var G=X.tooltip_title;var l=X.tooltip_content;for(var R in X.data[V]){G=G.replace("{"+R+"}",X.data[V][R]);l=l.replace("{"+R+"}",X.data[V][R])}N.data("tooltip",{id:V,title:G,content:l,color:B,x:A+(C.piechart["tooltip-position"]*Q)*Math.cos(f),y:z+(C.piechart["tooltip-position"]*Q)*Math.sin(f),element:N,options:C,paper:g});N.hover(d.element_tooltip)}k+=s}d.draw_legend(g,m,P,C);var W=Raphael.animation({transform:"s1.1 1.1 "+A+" "+z},C.layout["speed"],">");var J=Raphael.animation({transform:""},C.layout["speed"],"<");var e;for(V=0;V<S.length;++V){(function(i){i.mouseover(function(){T=v[i.data("index")];if(T){T.stop().animate(W)}M=o[i.data("index")];if(M){M.stop().animate(W)}e=W;e.anim["100"]["fill-opacity"]=1;i.stop().animate(e);delete e.anim["100"]["fill-opacity"]});i.mouseout(function(){T=v[i.data("index")];if(T){T.stop().animate(J)}M=o[i.data("index")];if(M){M.stop().animate(J)}e=J;e.anim["100"]["fill-opacity"]=i.data("color-alpha");i.stop().animate(e);delete e.anim["100"]["fill-opacity"]})})(S[V])}}})});