define(function(b,a,c){a.draw_barchart=function(e,u,ai,H,V,S){if(!e||!ai){return idb("Paper or Data is empty.")}var F=b("./infoviz.core");var D=F.merge_options(H),w=[],W,U,ad=0;var O=ai.data,B=[],ag,af,ae,J;var G=ai.horizontal_field,f=ai.vertical_field,K;var l,aj,E=Infinity,ak=-Infinity,Q=Infinity,q=-Infinity;var g=Infinity,T=-Infinity;if(F.is_array(f)){if(f.length===2){K=f[1];f=f[0]}else{f=f[0]}}var N;for(var r in O){if(!O[r]["axis"]||O[r]["axis"]<0||O[r]["axis"]>1){N=0}else{N=O[r]["axis"]}for(ag=0;ag<O[r]["data"].length;++ag){J=O[r]["data"][ag];if(J[G]!==undefined){l=J[G]}else{l="N/A"}if(l>ak){ak=l}if(l<E){E=l}if(F.in_array(l,B)===-1){B.push(l)}if(N===0){if(F.is_number(J[f])){aj=J[f]}else{aj="N/A"}if(aj>q){q=aj}if(aj<Q){Q=aj}}else{if(F.is_number(J[K])){aj=J[K]}else{aj="N/A"}if(aj>T){T=aj}if(aj<g){g=aj}}}++ad}Q=Math.floor(Q/10)*10;q=Math.ceil(q/10)*10;g=Math.floor(g/10)*10;T=Math.ceil(T/10)*10;var aa=u["top-left"][0]+D.barchart["padding-left"];var ac=u["bottom-left"][1]-D.barchart["padding-bottom"];var R=(ac-u["top-left"][1]-D.barchart["padding-top"])/(q-Q);var ah=(ac-u["top-left"][1]-D.barchart["padding-top"])/(T-g);var h={};var z=(ac-u["top-left"][1]-D.barchart["padding-top"])/(D.grid["vertical-label-count"]-1);var n=(q-Q)/(D.grid["vertical-label-count"]-1);var X=(ac-u["top-left"][1]-D.barchart["padding-top"])/(D.grid["vertical-label-count-right"]-1);var v=(T-g)/(D.grid["vertical-label-count-right"]-1);w=[];W=u["top-left"][0]-D.grid["vertical-bar-width"];U=ac;var m=Q;for(ag=0;ag<D.grid["vertical-label-count"];++ag){w.push("M"+W+","+U+"L"+u["top-left"][0]+","+U);e.path(w.join("")).attr({stroke:D.grid["axis-color"],"stroke-opacity":D.grid["axis-alpha"],"stroke-width":D.grid["axis-width"]}).translate(0.5,0.5);e.text(W-D.grid["vertical-bar-width"],U,m.toFixed(D.grid["vertical-label-round"])).attr({"text-anchor":"end",fill:D.grid["vertical-label-color"],"font-size":D.grid["vertical-label-size"]}).translate(0.5,0.5);U-=z;m+=n}if(D.grid["enable-right-axis"]){w=[];W=u["top-right"][0];U=ac;m=g;for(ag=0;ag<D.grid["vertical-label-count-right"];++ag){w.push("M"+W+","+U+"L"+(u["top-right"][0]+D.grid["vertical-bar-width-right"])+","+U);e.path(w.join("")).attr({stroke:D.grid["axis-color"],"stroke-opacity":D.grid["axis-alpha"],"stroke-width":D.grid["axis-width"]}).translate(0.5,0.5);e.text(W+2*D.grid["vertical-bar-width-right"],U,m.toFixed(D.grid["vertical-label-round"])).attr({"text-anchor":"start",fill:D.grid["vertical-label-color"],"font-size":D.grid["vertical-label-size"]}).translate(0.5,0.5);U-=X;m+=v}}var C=(u.width-D.barchart["padding-left"]-D.barchart["padding-right"]-(B.length-1)*D.barchart["group-margin"])/B.length;var P=(C-(ad-1)*D.barchart["bar-margin"])/ad;var o,t;w=[];W=aa+C/2;U=u["bottom-right"][1]+D.grid["horizontal-name-size"]/2+D.grid["horizontal-label-margin"]*2;for(ag=0;ag<B.length;++ag){w.push("M"+W+","+u["bottom-left"][1]);w.push("L"+W+","+u["top-left"][1]);h[B[ag]]=W-C/2;if(D.grid["horizontal-label-rotate"]){test_text=e.text(-1000,-1000,B[ag]).attr({"text-anchor":"middle","font-size":D.grid["horizontal-label-size"],transform:"r"+D.grid["horizontal-label-rotate"]}).translate(0.5,0.5);this_box=test_text.getBBox();t=e.text(W,U-D.grid["horizontal-label-margin"]*2+this_box.height/2,B[ag]).attr({"text-anchor":"middle","font-size":D.grid["horizontal-label-size"],fill:D.grid["horizontal-label-color"],transform:"r"+D.grid["horizontal-label-rotate"]}).translate(0.5,0.5)}else{t=e.text(W,U,B[ag]).attr({"text-anchor":"middle","font-size":D.grid["horizontal-label-size"],fill:D.grid["horizontal-label-color"]}).translate(0.5,0.5)}W+=C+D.barchart["group-margin"]}o=e.path(w.join(""));o.attr({stroke:D.grid["grid-color"],"stroke-dasharray":"--..","stroke-linecap":"butt","stroke-width":D.grid["grid-width"],"stroke-opacity":D.grid["grid-alpha"]});o.translate(0.5,0.5);var M=0,I,d=[],Z;var Y=[];for(var r in O){var A;if(!O[r]["axis"]||O[r]["axis"]<0||O[r]["axis"]>1){N=0}else{N=O[r]["axis"]}I=D.color[(M%D.color.length)];for(ag=0;ag<O[r]["data"].length;++ag){J=O[r]["data"][ag];W=h[J[G]]+(M)*(P+D.barchart["bar-margin"]);if(N===0){U=ac-(J[f]-Q)*R;Z=e.rect(W,U,P,u["bottom-left"][1]-U-1);Z.attr({stroke:I.color,"stroke-opacity":I["dark-alpha"],"stroke-width":D.barchart["border-width"],fill:I.color,"fill-opacity":I["light-alpha"]}).translate(0.5,0.5);d.push(Z)}else{U=ac-(J[K]-g)*ah;Z=e.rect(W,U,P,u["bottom-left"][1]-U-1);Z.attr({stroke:I.color,"stroke-opacity":I["dark-alpha"],"stroke-dasharray":"--","stroke-linecap":"butt","stroke-width":D.barchart["border-width"],fill:I.color,"fill-opacity":I["light-alpha"]}).translate(0.5,0.5);d.push(Z)}if(V&&typeof(V)==="function"){Z.data("info",{x:W,y:U,h_value:J[G],v_value:(N===0)?J[f]:J[K],axis:N,data:J,that:S,callback:V});Z.click(F.element_action)}if(ai.tooltip_title||ai.tooltip_content){var L=ai.tooltip_title;var s=ai.tooltip_content;for(var ab in J){L=L.replace("{"+ab+"}",J[ab]);s=s.replace("{"+ab+"}",J[ab])}Z.data("tooltip",{id:r+ag,title:L,content:s,color:I,x:W+P/2,y:U,element:Z,options:D,paper:e});Z.hover(F.element_tooltip)}}Y.push({label:O[r]["name"],color:I,type:"box"});M++}F.draw_legend(e,u,Y,D);for(ag=0;ag<d.length;++ag){(function(i){i.mouseover(function(){i.stop().animate({"fill-opacity":D.color[0]["dark-alpha"]},D.layout["speed"],">")});i.mouseout(function(){i.stop().animate({"fill-opacity":D.color[0]["light-alpha"]},D.layout["speed"],"<")})})(d[ag])}}});