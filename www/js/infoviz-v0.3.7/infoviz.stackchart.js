define(function(b,a,c){a.draw_stackchart=function(e,u,ae,H,R,P){if(!e||!ae){return idb("Paper or Data is empty.")}var F=b("./infoviz.core");var D=F.merge_options(H),v=[],S,Q,Z=0;var M=ae.data,B=[],ac,ab,aa,J;var G=ae.horizontal_field,f=ae.vertical_field;var l,af,N=Infinity,ag=-Infinity;var m={};for(var r in M){for(ac=0;ac<M[r]["data"].length;++ac){J=M[r]["data"][ac];if(J[G]!==undefined){l=J[G]}else{l="N/A"}if(F.in_array(l,B)===-1){B.push(l);m[l]=0}if(F.is_number(J[f])){af=J[f]}else{af="N/A"}m[l]+=af}++Z}for(var V in m){if(m[V]>ag){ag=m[V]}}N=0;var W=u["top-left"][0]+D.stackchart["padding-left"];var Y=u["bottom-left"][1]-D.stackchart["padding-bottom"];var O=(Y-u["top-left"][1]-D.stackchart["padding-top"]-D.stackchart["bar-margin"]*(Z-1))/ag;var h={};var w=(Y-u["top-left"][1]-D.stackchart["padding-top"])/(D.grid["vertical-label-count"]-1);var o=(ag-N)/(D.grid["vertical-label-count"]-1);v=[];S=u["top-left"][0]-D.grid["vertical-bar-width"];Q=Y;var n=N;for(ac=0;ac<D.grid["vertical-label-count"];++ac){v.push("M"+S+","+Q+"L"+u["top-left"][0]+","+Q);e.path(v.join("")).attr({stroke:D.grid["axis-color"],"stroke-opacity":D.grid["axis-alpha"],"stroke-width":D.grid["axis-width"]}).translate(0.5,0.5);e.text(S-D.grid["vertical-bar-width"],Q,n.toFixed(D.grid["vertical-label-round"])).attr({"text-anchor":"end",fill:D.grid["vertical-label-color"],"font-size":D.grid["vertical-label-size"]}).translate(0.5,0.5);Q-=w;n+=o}var C=(u.width-D.stackchart["padding-left"]-D.stackchart["padding-right"]-(B.length-1)*D.barchart["group-margin"])/B.length;var q,t;v=[];S=W+C/2;Q=u["bottom-right"][1]+D.grid["horizontal-name-size"]/2+D.grid["horizontal-label-margin"]*2;for(ac=0;ac<B.length;++ac){v.push("M"+S+","+u["bottom-left"][1]);v.push("L"+S+","+u["top-left"][1]);h[B[ac]]=S-C/2;t=e.text(S,Q,B[ac]).attr({"text-anchor":"middle","font-size":D.grid["horizontal-label-size"],fill:D.grid["horizontal-label-color"]}).translate(0.5,0.5);if(D.grid["horizontal-label-rotate"]){t.transform("r"+D.grid["horizontal-label-rotate"])}S+=C+D.stackchart["group-margin"]}q=e.path(v.join(""));q.attr({stroke:D.grid["grid-color"],"stroke-dasharray":"--..","stroke-linecap":"butt","stroke-width":D.grid["grid-width"],"stroke-opacity":D.grid["grid-alpha"]});q.translate(0.5,0.5);var E={};for(var ad in h){E[ad]=Y}var L=0,I,d=[],U;var T=[];for(var r in M){var A,z;I=D.color[(L%D.color.length)];for(ac=0;ac<M[r]["data"].length;++ac){J=M[r]["data"][ac];z=O*J[f];S=h[J[G]];Q=E[J[G]]-z-D.stackchart["bar-margin"];U=e.rect(S,Q,C,z);U.attr({stroke:I.color,"stroke-opacity":I["dark-alpha"],"stroke-width":D.stackchart["border-width"],fill:I.color,"fill-opacity":I["light-alpha"]}).translate(0.5,0.5);d.push(U);if(R&&typeof(R)==="function"){U.data("info",{x:S,y:Q,h_value:J[G],v_value:J[f],data:J,callback:R,that:P});U.click(F.element_action)}if(ae.tooltip_title||ae.tooltip_content){var K=ae.tooltip_title;var s=ae.tooltip_content;for(var X in J){K=K.replace("{"+X+"}",J[X]);s=s.replace("{"+X+"}",J[X])}U.data("tooltip",{id:r+ac,title:K,content:s,color:I,x:S+C/2,y:Q,element:U,options:D,paper:e});U.hover(F.element_tooltip)}E[J[G]]=Q}T.push({label:M[r]["name"],color:I,type:"box"});L++}F.draw_legend(e,u,T,D);for(ac=0;ac<d.length;++ac){(function(g){g.mouseover(function(){g.stop().animate({"fill-opacity":D.color[0]["dark-alpha"]},D.layout["speed"],">")});g.mouseout(function(){g.stop().animate({"fill-opacity":D.color[0]["light-alpha"]},D.layout["speed"],"<")})})(d[ac])}}});