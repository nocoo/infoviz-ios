define(function(b,a,c){a.draw_streamchart=function(d,o,S,A,G,E){if(!d||!S){return idb("Paper or Data is empty.")}var z=b("./infoviz.core");var v=z.merge_options(A),q=[],I,F;var R,Q,P,B,e=0;var K=o["top-left"][0]+v.streamchart["padding-left"];var N=o["bottom-left"][1]-v.streamchart["padding-bottom"];var s={};for(R=0;R<S.data.length;++R){B=S.data[R];for(Q=0;Q<B.data.length;++Q){if(!s[B.data[Q][S.horizontal_field]]){s[B.data[Q][S.horizontal_field]]={sum:0,max:-Infinity,min:Infinity,y:N};e++}}}for(R=0;R<S.data.length;++R){B=S.data[R];var O;for(Q=0;Q<B.data.length;++Q){O=s[B.data[Q][S.horizontal_field]];O.sum+=B.data[Q][S.value_field];O.max=(B.data[Q][S.value_field]>O.max)?B.data[Q][S.value_field]:O.max;O.min=(B.data[Q][S.value_field]<O.min)?B.data[Q][S.value_field]:O.min}}var n=[];for(R=0;R<S.data.length;++R){B=S.data[R];var H,h=z.filter_node(B,["data"]);h.data=[];h.areas=[];var D=0;for(H in s){h.data[D++]=0}for(Q=0;Q<B.data.length;++Q){h.data[Q]={stream:R,field:B.data[Q][S.horizontal_field],ratio:B.data[Q][S.value_field]/s[B.data[Q][S.horizontal_field]]["sum"]}}n.push(h)}var w=N-o["top-left"][1]-v.streamchart["padding-top"];var r=w/(v.grid["vertical-label-count"]-1);var g=1/(v.grid["vertical-label-count"]-1);g=Math.round(g*Math.pow(10,2))/Math.pow(10,2);q=[];I=o["top-left"][0]-v.grid["vertical-bar-width"];F=N;var f=0;for(R=0;R<v.grid["vertical-label-count"];++R){q.push("M"+I+","+F+"L"+o["top-left"][0]+","+F);d.path(q.join("")).attr({stroke:v.grid["axis-color"],"stroke-opacity":v.grid["axis-alpha"],"stroke-width":v.grid["axis-width"]}).translate(0.5,0.5);d.text(I-v.grid["vertical-bar-width"],F,f.toFixed(v.grid["vertical-label-round"])).attr({"text-anchor":"end",fill:v.grid["vertical-label-color"],"font-size":v.grid["vertical-label-size"]}).translate(0.5,0.5);F-=r;f+=g}var K=o["top-left"][0]+v.streamchart["padding-left"];var u=Math.floor((o.width-v.streamchart["padding-left"]-v.streamchart["padding-right"])/(e-1));I=K;var l;for(B in s){F=Math.floor(o["bottom-right"][1]+v.grid["horizontal-name-size"]/2+v.grid["horizontal-label-margin"]*2);l=d.text(I,F,B).attr({"text-anchor":"middle","text-weight":"normal","font-size":v.grid["horizontal-label-size"],fill:v.grid["horizontal-label-color"]}).translate(0.5,0.5);if(v.grid["horizontal-label-rotate"]){l.transform("r"+v.grid["horizontal-label-rotate"])}I+=u}var J=[];for(R=0;R<n.length;++R){var h=n[R];var t=v.color[(R%v.color.length)];for(Q=0;Q<h.data.length-1;++Q){q=[];q.push("M"+(K+Q*u)+","+s[h.data[Q]["field"]]["y"]);q.push("L"+(K+(Q+1)*u)+","+s[h.data[Q+1]["field"]]["y"]);q.push("L"+(K+(Q+1)*u)+","+(s[h.data[Q+1]["field"]]["y"]-w*h.data[Q+1]["ratio"]));q.push("L"+(K+Q*u)+","+(s[h.data[Q]["field"]]["y"]-w*h.data[Q]["ratio"]));q.push("Z");s[h.data[Q]["field"]]["y"]-=w*h.data[Q]["ratio"];if(Q===h.data.length-2){s[h.data[Q+1]["field"]]["y"]-=w*h.data[Q+1]["ratio"]}var L=d.path(q.join("")).attr({stroke:t.color,"stroke-opacity":t["dark-alpha"],"stroke-width":v.streamchart["border-width"],fill:t.color,"fill-opacity":t["light-alpha"]}).translate(0.5,0.5);if(G&&typeof(G)==="function"){L.data("info",{x:(K+Q*u),y:s[h.data[Q]["field"]]["y"],stream:h,area:S.data[R]["data"][Q],that:E,callback:G});L.click(z.element_action)}if(S.tooltip_title||S.tooltip_content){var C=S.tooltip_title;var m=S.tooltip_content;for(var M in h){C=C.replace("{"+M+"}",h[M]);m=m.replace("{"+M+"}",h[M])}for(var M in S.data[R]["data"][Q]){C=C.replace("{"+M+"}",S.data[R]["data"][Q][M]);m=m.replace("{"+M+"}",S.data[R]["data"][Q][M])}L.data("tooltip",{id:"s"+R+"a"+Q,title:C,content:m,color:t,x:(K+Q*u)+u/2,y:s[h.data[Q]["field"]]["y"],element:L,options:v,paper:d});L.hover(z.element_tooltip)}L.data("animation",{stream:R,dark:t["dark-alpha"],light:t["light-alpha"]});h.areas.push(L)}J.unshift({label:h[S.stream_field],color:t,type:"area"})}z.draw_legend(d,o,J,v)}});